name: Sync and Translate

on:
  schedule:
    - cron: '0 0 * * *'  # 每天凌晨同步并翻译
  workflow_dispatch:      # 手动触发执行

permissions:
  contents: write        # 必须赋予写权限，否则无法推送到你的分支

jobs:
  sync-and-translate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout target repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 获取完整历史记录，方便合并

      # 第一步：同步上游仓库
      - name: Sync from Upstream
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }} # 使用内置 Token，无需额外设置
        run: |
          gh repo sync ${{ github.repository }} --source https://github.com/langchain-ai/docs.git
          git pull 

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install openai tiktoken 

      # 第二步：运行你之前的翻译脚本
      - name: Run Translation Script
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        run: python translate.py

      # 第三步：将同步后的代码和新翻译的内容一起推送到你的分支
      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "docs: sync upstream and update auto-translation" || echo "No changes to commit"
          git push
